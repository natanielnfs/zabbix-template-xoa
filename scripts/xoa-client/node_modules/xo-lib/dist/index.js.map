{"version":3,"sources":["../src/index.js"],"names":["noop","XoError","BaseError","Xo","JsonRpcWebSocketClient","constructor","credentials","url","opts","_credentials","_user","on","OPEN","_signIn","catch","CLOSED","user","call","method","args","i","startsWith","Promise","reject","promise","retry","predicate","error","refreshUser","then","signIn","emit"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;;;AAIA,MAAMA,IAAI,GAAG,MAAM,CAAE,CAArB;;AAIO,MAAMC,OAAN,SAAsBC,oBAAtB,CAAgC;;;;AAIxB,MAAMC,EAAN,SAAiBC,8CAAjB,CAAwC;AACrDC,EAAAA,WAAW,GAA2C;AAAA,QAA1C;AAAEC,MAAAA,WAAF;AAAeC,MAAAA,GAAG,GAAG,GAArB;AAA0B,SAAGC;AAA7B,KAA0C,uEAAJ,EAAI;AACpDA,IAAAA,IAAI,CAACD,GAAL,GAAY,GAAE,sBAAQA,GAAR,EAAa,GAAb,CAAkB,OAAhC;AACA,UAAMC,IAAN;AAEA,SAAKC,YAAL,GAAoBH,WAApB;AACA,SAAKI,KAAL,GAAa,IAAb;AAEA,SAAKC,EAAL,CAAQC,4BAAR,EAAc,MAAM;AAClB,UAAI,KAAKH,YAAT,EAAuB;AACrB,aAAKI,OAAL,CAAa,KAAKJ,YAAlB,EAAgCK,KAAhC,CAAsCd,IAAtC;AACD;AACF,KAJD;AAKA,SAAKW,EAAL,CAAQI,8BAAR,EAAgB,MAAM;AACpB,WAAKL,KAAL,GAAa,IAAb;AACD,KAFD;AAGD;;AAEO,MAAJM,IAAI,GAAG;AACT,WAAO,KAAKN,KAAZ;AACD;;AAEDO,EAAAA,IAAI,CAACC,MAAD,EAASC,IAAT,EAAeC,CAAf,EAAkB;AACpB,QAAIF,MAAM,CAACG,UAAP,CAAkB,UAAlB,CAAJ,EAAmC;AACjC,aAAOC,OAAO,CAACC,MAAR,CAAe,IAAItB,OAAJ,CAAY,sDAAZ,CAAf,CAAP;AACD;;AAED,UAAMuB,OAAO,GAAG,MAAMP,IAAN,CAAWC,MAAX,EAAmBC,IAAnB,CAAhB;;AACAK,IAAAA,OAAO,CAACC,KAAR,GAAgBC,SAAS,IACvBF,OAAO,CAACV,KAAR,CAAca,KAAK,IAAI;AACrBP,MAAAA,CAAC,GAAG,CAACA,CAAC,IAAI,CAAN,IAAW,CAAf;;AACA,UAAIM,SAAS,CAACC,KAAD,EAAQP,CAAR,CAAb,EAAyB;AACvB,eAAO,KAAKH,IAAL,CAAUC,MAAV,EAAkBC,IAAlB,EAAwBC,CAAxB,CAAP;AACD;AACF,KALD,CADF;;AAQA,WAAOI,OAAP;AACD;;AAEDI,EAAAA,WAAW,GAAG;AACZ,WAAO,MAAMX,IAAN,CAAW,iBAAX,EAA8BY,IAA9B,CAAmCb,IAAI,IAAI;AAChD,aAAQ,KAAKN,KAAL,GAAaM,IAArB;AACD,KAFM,CAAP;AAGD;;AAEDc,EAAAA,MAAM,CAACxB,WAAD,EAAc;AAElB,SAAKG,YAAL,GAAoBH,WAApB;AAEA,WAAO,KAAKO,OAAL,CAAaP,WAAb,CAAP;AACD;;AAEDO,EAAAA,OAAO,CAACP,WAAD,EAAc;AACnB,WAAO,MAAMW,IAAN,CAAW,gBAAX,EAA6BX,WAA7B,EAA0CuB,IAA1C,CACLb,IAAI,IAAI;AACN,WAAKN,KAAL,GAAaM,IAAb;AACA,WAAKe,IAAL,CAAU,eAAV;AACD,KAJI,EAKLJ,KAAK,IAAI;AACP,WAAKI,IAAL,CAAU,uBAAV,EAAmCJ,KAAnC;AACA,YAAMA,KAAN;AACD,KARI,CAAP;AAUD;;AA/DoD","sourcesContent":["import trimEnd from 'lodash/trimEnd'\nimport { BaseError } from 'make-error'\nimport { JsonRpcWebSocketClient, OPEN, CLOSED } from 'jsonrpc-websocket-client'\n\n// ===================================================================\n\nconst noop = () => {}\n\n// ===================================================================\n\nexport class XoError extends BaseError {}\n\n// -------------------------------------------------------------------\n\nexport default class Xo extends JsonRpcWebSocketClient {\n  constructor({ credentials, url = '.', ...opts } = {}) {\n    opts.url = `${trimEnd(url, '/')}/api/`\n    super(opts)\n\n    this._credentials = credentials\n    this._user = null\n\n    this.on(OPEN, () => {\n      if (this._credentials) {\n        this._signIn(this._credentials).catch(noop)\n      }\n    })\n    this.on(CLOSED, () => {\n      this._user = null\n    })\n  }\n\n  get user() {\n    return this._user\n  }\n\n  call(method, args, i) {\n    if (method.startsWith('session.')) {\n      return Promise.reject(new XoError('session.*() methods are disabled from this interface'))\n    }\n\n    const promise = super.call(method, args)\n    promise.retry = predicate =>\n      promise.catch(error => {\n        i = (i || 0) + 1\n        if (predicate(error, i)) {\n          return this.call(method, args, i)\n        }\n      })\n\n    return promise\n  }\n\n  refreshUser() {\n    return super.call('session.getUser').then(user => {\n      return (this._user = user)\n    })\n  }\n\n  signIn(credentials) {\n    // Register this credentials for future use.\n    this._credentials = credentials\n\n    return this._signIn(credentials)\n  }\n\n  _signIn(credentials) {\n    return super.call('session.signIn', credentials).then(\n      user => {\n        this._user = user\n        this.emit('authenticated')\n      },\n      error => {\n        this.emit('authenticationFailure', error)\n        throw error\n      }\n    )\n  }\n}\n"],"file":"index.js"}